# Force GitHub CLI to treat testscript as TTY
env GH_FORCE_TTY=80
env REPO=$SCRIPT_NAME-$RANDOM_STRING

# Create a repository where the variable will be registered
exec gh repo create $ORG/$REPO --add-readme --private

# Defer repo cleanup
defer gh repo delete --yes $ORG/$REPO

# Clone the repo
exec gh repo clone $ORG/$REPO
cd $REPO

# Create a repository environment, will fail if organization does not have environment support
exec gh api /repos/$ORG/$REPO/environments/testscripts -X PUT --jq '.name'
stdout 'testscripts'

# Verify no repository environment variables exist
exec gh variable list --env testscripts
stderr 'no variables found'

# Create a repository environment variable
exec gh variable set TESTSCRIPTS_ENV --env testscripts --body 'just a repo env variable'
stdout 'Created variable TESTSCRIPTS_ENV for'

# Verify new repository environment variable exists
exec gh variable list --env testscripts
stdout 'TESTSCRIPTS_ENV\s+just a repo env variable\s+less than a minute ago'

# Verify repository environment variable can be retrieved
exec gh variable get TESTSCRIPTS_ENV --env testscripts
stdout 'just a repo env variable'
