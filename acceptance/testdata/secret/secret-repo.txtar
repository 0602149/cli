# Setup environment variables to force TTY
env GH_FORCE_TTY=80

# Create a repository where the secret will be registered
exec gh repo create $ORG/$SCRIPT_NAME-$RANDOM_STRING --add-readme --private

# Defer repo cleanup
defer gh repo delete --yes $ORG/$SCRIPT_NAME-$RANDOM_STRING

# Clone the repo
exec gh repo clone $ORG/$SCRIPT_NAME-$RANDOM_STRING

# Verify no repository secrets exist
cd $SCRIPT_NAME-$RANDOM_STRING
exec gh secret list
stderr 'no secrets found'

# Create a repository secret
exec gh secret set TESTSCRIPTS --body 'does not matter as cannot read it once set'
stdout 'Set Actions secret TESTSCRIPTS for'

# Verify new repository secret exists
exec gh secret list
stdout 'TESTSCRIPTS\s+less than a minute ago'
